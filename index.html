<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Calendar Parser</title>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.4.0/bootstrap.min.css">
    <style type="text/css" media="screen">
/*        html,body{height:100%;margin:0;padding:0;}*/
/*        #container {width:96%;margin:2%;}*/
        #authenticated-pane{display:none;margin:20px;padding-right:290px;}
        #default-pane{color:red;}
        #topbar{margin:20px;padding-right:290px;}
        #urlinput{width:98%;}
        #previewpane{position:fixed;top:0px;bottom:0px;right:0px;width:290px;border-left:3px solid #111;box-shadow: 0 3px 7px rgba(0, 0, 0, 0.3);}
    	#previewpane h3 {padding:10px;line-height:1.5em;background-color:#F5F5F5;border-bottom: 1px solid #EEEEEE;}
    	#previewpane .content {padding:10px;}
        tr:nth-child(odd)    { background-color:#eee; }
        tr:nth-child(even)    { background-color:#fff; }
        td > input { margin-left: 1em; }
        .popover .inner { width: 450px; }
    </style>
    <script type="text/javascript" src="http://www.google.com/jsapi?key=AIzaSyC9lKLqnXY1LvMiwM-TY-irkN91O-msSHk"></script>
    <script type="text/javascript" src="js/gcal.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery-1.7.1.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/bootstrap-twipsy.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/bootstrap-popover.js" charset="utf-8"></script>
    <!-- // <script type="text/javascript" src="js/require.js" charset="utf-8"></script> -->
    <!-- <script type="text/javascript" src="js/assert.js" charset="utf-8"></script> -->
    <!-- <script type="text/javascript" charset="utf-8">
    /**
     * Adds all missing properties from second obj to first obj
     */ 
    window.inherits = function(first, second){
        for (var prop in second){
            first[prop] = second[prop];
        }
    }
    // // patch browser to CommonJS, from https://github.com/alexyoung/turing-test.js/blob/master/turing-test.js
    // window.browserPaths = [];
    // window.load = function(script, eval) {
    //     if (!script.match(/\.js$/)) {
    //         script = script + '.js';
    //     }
    // 
    //     if (!script.match(/\//)) {
    //         script = window.browserPaths[0] + '/' + script;
    //         script = script.replace(/\.\//, '');
    //     }
    // 
    //     function loadIEScript() {
    //         var id = '__id_' + (new Date()).valueOf(),
    //             timer,
    //             scriptTag;
    //         // document.write('<script id="' + id + '" type="text/javascript" src="' + script + '">');
    //         document.write('<script id="' + id + '" type="text/javascript" src="' + script + '" />');
    //         scriptTag = document.getElementById(id);
    // 
    //         timer = setInterval(function() {
    //                 if (/loaded|complete/.test(scriptTag.readyState)) {
    //                     clearInterval(timer);
    //                 }
    //             }, 10);
    //     }
    // 
    //     function loadOtherScript() {
    //         var scriptTag = document.createElement('script'),
    //         head = document.getElementsByTagName('head');
    //         // scriptTag.onload = function() { tt.doneLoading(); };
    //         scriptTag.setAttribute('type', 'text/javascript');
    //         scriptTag.setAttribute('src', script);
    //         head[0].insertBefore(scriptTag, head.firstChild);
    //     }
    // 
    //     if (document.attachEvent) {
    //         loadIEScript();
    //     } else {
    //         loadOtherScript();
    //     }
    // }
    // window.exports = [];
    // window.__dirname = '';
    // 
    // window.require = function(path) {
    //     exports = {};
    //     window.load(path);
    // 
    //     return {};
    // }
    // 
    // window.require.paths = {
    //     unshift: function(path) {
    //         window.browserPaths.push(path);
    //     }
    // }
    </script> -->
    <!-- // <script type="text/javascript" src="js/icalendar.js" charset="utf-8"></script> -->
    <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
        var letterbullets = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'];
        function ol2txt(obj,level,ndx,str) {
            if($(obj).length>1) {
                console.log('Error: multiple objects passed to ol2txt');
                return;
            }
            if($(obj).eq(0).is('ol')){
                // If node has children, recurse on all its children
                $(obj).children().each(function(i){
                    str += ol2txt($(this),level,i,"");
                });
            } else if($(obj).eq(0).is('li')) {
                // If node is an li, print it as text
                str += new Array(level+1).join("  ");
                if((level%2)==0) {
                    str += (ndx+1)+". ";
                } else {
                    str += "  "+letterbullets[ndx]+". ";
                }
                $(obj).contents().each(function(){
                    str += ol2txt(this,level+1,0,"");
                });
            } else {
                // Print node as text
                str += $(obj).text()+"\n";
            }
            return str;
        }
        function proxify(str) { return ("proxy.php?url="+encodeURIComponent(str)); }
        $("#urlinput").click(function(){ $(this).select(); return false; });
        $('input#urlsubmit').click(function(){
            if (google.accounts.user.checkLogin(EVENT_FEED_URL)) {
            $('input#add-to-google').attr('disabled', 'disabled');
            $('div#container').load(proxify($('#urlinput').val()), function() {
                // console.log(proxify($('#urlinput').val()));
                // Get timetable at top of page
                var $timetable = $('a[name="top"]').siblings('table').eq(0);
                var events = new Array;
                var startdate, enddate, datestr, timestr;
                $timetable.find('tr').each(function(rownum){
                    var $cells = $(this).children('td');
                    if($cells.length==0) { return; } // No td children means row only contains th cells
                    // If this row has a multicolumn cell, it might be the date row
                    if($cells.eq(0).attr('colspan')) {
                        // If the cell says "Back to Top", it's not the date
                        if($cells.eq(0).text().match(/Back to Top/i)) { return; }
                        // Otherwise it should be the date
                        datestr = $cells.eq(0).text();
                    } else {
                        // Get time if present
                        timestr = $cells.eq(0).text();
                        if(timestr.length>0) {
                            startdate = new Date(datestr+", "+timestr);
                            enddate = new Date(startdate);
                            enddate.setHours(enddate.getHours()+2);
                        }
                        // Get title
                        var titlestr = $cells.eq(1).text();
                        // Swap (S) (H) (J) to front of title, if present
                        var bits = titlestr.match(/(.*)\((S|H|J)\)/);
                        if(bits && bits.length>=3) { titlestr = "("+bits[2]+")"+" "+bits[1]; }
                        // Get location
                        var locstr = $cells.eq(2).text();
                        var theevent = {title:titlestr, location:locstr, startdate:ISODateString(startdate), enddate:ISODateString(enddate)};
                        // If the event has links to a lower part of the page with a number, it has additional details we can get
                        var eventid = ($cells.eq(1).find('a[href]').attr('href') || "").substr(1);
                        if(eventid!="") {
                            // Get details
                            var $detailsnode = $('a[name='+eventid+']').next('span').next('div').clone();
                            // Wrap all the textnodes in span tags, in order to get them to show up as html nodes later
                            $detailsnode.contents().filter(function() {return this.nodeType == 3;}).wrap('<span></span>');
                            var $details = $detailsnode.find('b').eq(1).nextAll().andSelf();
                            // Parse lists in details
                            $details.filter('ol').each(function(){
                                $(this).text(ol2txt(this,0,1,"\n"));
                            });
                            // Replace <br> elems in details with newlines
                            $details.filter('br').each(function(){
                                $(this).replaceWith("<span></span>").text("\n");
                            });
                            theevent.details = $details.text();
                            // Remove trailing newlines
                            theevent.details = theevent.details.replace(/\n+$/,"");
                            // Replace multiple consecutive newlines with a single newline
                            // theevent.details = theevent.details.replace(/\n+/g,"\n")
                            theevent.eventid = eventid;
                            // Add tooltip with details to entry in the schedule
                            $(this).attr({"data-original-title":theevent.title, "data-content":(theevent.details).replace(/\n/g, "<br>")});
                            // $(this).popover({"placement":"above","html":true});
                            $(this).hover(function(){
                                $("#previewpane > h3").text($(this).attr("data-original-title"));
                                $("#previewpane > .content").html($(this).attr("data-content"));
                            },function(){
                                $("#previewpane > h3").text("");
                                $("#previewpane > .content").html("");
                            });
                        }
                        // Add event to list
                        events.push(theevent);
                        // Add checkbox to row
                        // $(this).append('<td><input type="checkbox" name="event" value="'+(events.length-1)+'" checked="checked"></td>');
                        $(this).append('<td><input type="checkbox" name="event" value="'+(events.length-1)+'"></td>');
                    }
                });
                // Add button to submit checked events to calendar
                $('input#add-to-google').click(function(){
                    // Get list of checked events
                    $timetable.find("input:checked").each(function(){
                        var i = $(this).val();
                        myCalendar.addEvent(events[i].startdate, events[i].enddate, events[i].title, events[i].details, events[i].location);
                    });
                });
                // Add button to submit checked events to calendar
                $('input#add-to-ics').click(function(){
                    // Get list of checked events
                    $timetable.find("input:checked").each(function(){
                        var i = $(this).val();
                        myCalendar.addEvent(events[i].startdate, events[i].enddate, events[i].title, events[i].details, events[i].location);
                    });
                });
                $('input#add-to-google').removeAttr('disabled');
            });
        }
        });
        // Initialise calendar functionality
        cal_init();
        // For now, automatically trigger the click
        // $('input#urlsubmit').click();
    });
</script>
</head>
<body>
    <!-- <div class="container"> -->
        <div id="topbar">
            <p><input name="urlinput" id="urlinput" value="http://listserv.wa.gov"></p>
            <p><input class="btn" type="submit" name="urlsubmit" id="urlsubmit" value="Load URL">
            <input class="btn" type="submit" name="add-to-google" id="add-to-google" value="Add Checked Events to Google Calendar" disabled="disabled"></p>
        </div>
        <div id="authenticated-pane">
            <input class="btn" id="logout-button" type="button" value="Logout Google Calendar" onclick="logMeOut()">
            <div id="container"></div>
            <div id="previewpane">
                <h3></h3>
                <div class="content"></div>
            </div>
        </div>
        <div id="default-pane">
            Need to login first: <input class="btn" id="auth-button" type="button" value="Login Google Calendar" onclick="logMeIn()">
        </div>
        <img src="x.png" style="position:absolute; top: -1000px;">
    <!-- </div> -->
</body>
</html>
